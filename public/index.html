<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>大森サポートツール</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      overflow-x: hidden;
      overscroll-behavior: none;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
      background: #0f0f1a;
      min-height: 100vh;
      color: #e0e0e0;
      position: fixed;
      width: 100%;
      height: 100%;
    }

    .chat-page {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: radial-gradient(ellipse at top, #1a1a3e 0%, #0f0f1a 60%);
    }

    /* ===== HEADER ===== */
    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 28px;
      background: rgba(255,255,255,0.04);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .header-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      box-shadow: 0 4px 16px rgba(102,126,234,0.3);
    }

    .chat-header-left h1 {
      color: #fff;
      font-size: 1.15rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .chat-header-left p {
      color: rgba(255,255,255,0.4);
      font-size: 0.72rem;
      margin-top: 1px;
    }

    .chat-header-btns {
      display: flex;
      gap: 8px;
    }

    .chat-reset-btn {
      padding: 7px 16px;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 8px;
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.6);
      font-size: 0.78rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chat-reset-btn:hover {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }

    /* ===== CHAT MESSAGES ===== */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 28px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .chat-messages::-webkit-scrollbar { width: 6px; }
    .chat-messages::-webkit-scrollbar-track { background: transparent; }
    .chat-messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

    .chat-bubble {
      max-width: 78%;
      padding: 16px 20px;
      border-radius: 18px;
      line-height: 1.75;
      font-size: 0.9rem;
      white-space: pre-wrap;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .chat-bubble.bot {
      align-self: flex-start;
      background: rgba(255, 255, 255, 0.07);
      color: #e0e0e0;
      border: 1px solid rgba(255,255,255,0.08);
      border-bottom-left-radius: 4px;
      backdrop-filter: blur(8px);
    }

    .chat-bubble.user {
      align-self: flex-end;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      border-bottom-right-radius: 4px;
      box-shadow: 0 4px 20px rgba(102,126,234,0.25);
    }

    .chat-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .chat-option-btn {
      padding: 8px 16px;
      border: 1px solid rgba(102,126,234,0.5);
      border-radius: 20px;
      background: rgba(102,126,234,0.1);
      color: #a0b4ff;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }

    .chat-option-btn:hover {
      background: rgba(102,126,234,0.3);
      color: #fff;
      border-color: #667eea;
      box-shadow: 0 0 16px rgba(102,126,234,0.2);
    }

    .chat-category-label {
      font-size: 0.72rem;
      color: rgba(255,255,255,0.35);
      margin-top: 10px;
      margin-bottom: 4px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* ===== INPUT AREA ===== */
    .chat-input-area {
      display: flex;
      gap: 10px;
      padding: 16px 28px;
      background: rgba(255,255,255,0.03);
      border-top: 1px solid rgba(255,255,255,0.06);
    }

    .chat-input-area input {
      flex: 1;
      padding: 14px 20px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 14px;
      font-size: 0.92rem;
      outline: none;
      background: rgba(255,255,255,0.06);
      color: #fff;
      transition: border-color 0.2s;
    }

    .chat-input-area input::placeholder { color: rgba(255,255,255,0.3); }
    .chat-input-area input:focus { border-color: rgba(102,126,234,0.5); }

    .chat-send-btn {
      padding: 14px 28px;
      border: none;
      border-radius: 14px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 16px rgba(102,126,234,0.3);
    }

    .chat-send-btn:hover {
      box-shadow: 0 4px 24px rgba(102,126,234,0.5);
      transform: translateY(-1px);
    }

    .chat-send-btn:disabled {
      background: rgba(255,255,255,0.1);
      box-shadow: none;
      cursor: not-allowed;
      transform: none;
    }

    .chat-disclaimer {
      padding: 10px 28px;
      background: rgba(0,0,0,0.3);
      color: rgba(255,255,255,0.25);
      font-size: 0.68rem;
      text-align: center;
      letter-spacing: 0.01em;
    }

    /* ===== THINKING ===== */
    .thinking-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      align-self: flex-start;
      padding: 14px 20px;
      background: rgba(255,255,255,0.07);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      border-bottom-left-radius: 4px;
      color: rgba(255,255,255,0.5);
      font-size: 0.82rem;
      animation: fadeIn 0.3s ease;
    }

    .thinking-dots span {
      display: inline-block;
      width: 7px;
      height: 7px;
      background: #667eea;
      border-radius: 50%;
      animation: blink 1.4s infinite;
      margin: 0 2px;
    }

    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0.2; }
      40% { opacity: 1; }
    }

    /* ===== MOBILE ===== */
    @media (max-width: 600px) {
      .chat-bubble { max-width: 95%; font-size: 0.85rem; }
      .chat-header { padding: 12px 16px; }
      .chat-messages { padding: 12px 14px; }
      .chat-input-area { padding: 10px 14px; }
      .chat-send-btn { padding: 14px 18px; font-size: 0.85rem; }
      .header-icon { width: 34px; height: 34px; font-size: 1rem; }
      .chat-options { gap: 6px; }
      .chat-option-btn { padding: 6px 12px; font-size: 0.75rem; }
      .chat-disclaimer { padding: 8px 14px; }
    }
  </style>
</head>
<body>
  <div class="chat-page">
    <div class="chat-header">
      <div class="chat-header-left">
        <div class="header-icon">&#9998;</div>
        <div>
          <h1>大森サポートツール</h1>
          <p>在留資格・就労相談ボット</p>
        </div>
      </div>
      <div class="chat-header-btns">
        <button class="chat-reset-btn" onclick="resetChat()">リセット</button>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-area">
      <input type="text" id="chatInput" placeholder="質問を入力してください..." />
      <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">送信</button>
    </div>
    <div class="chat-disclaimer">
      ※ 出入国在留管理庁・厚生労働省・法務省の公的情報に基づくAI回答です。最終判断は管轄の地方出入国在留管理局にご確認ください。
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    let conversationHistory = [];
    let isSending = false;

    const SYSTEM_PROMPT = `あなたは「株式会社アイシン」の人事部門を支援する、在留資格と就労制限の専門アシスタントです。
株式会社アイシンは製造業（工場での生産・加工・組立・検品等）を主たる事業としており、外国人従業員を幅広い在留資格で雇用しています。

## あなたの役割
- 株式会社アイシンの人事担当者からの質問に対して、製造業の現場に即した正確で実用的な回答を提供する
- ユーザーから「在留資格の種類」と「従事させたい業務内容」を聞き取り、その業務が当該在留資格で許可されるか判断する
- まだ在留資格が伝えられていない場合は、まず在留資格を確認する
- 在留資格がわかったら、具体的にどのような製造業務について知りたいか聞く

## 回答フォーマット
回答の最初の行は必ず以下のいずれかのタグで始めてください：
- 【OK - 就労可能】: その業務が明確に許可される場合
- 【NG - 就労不可】: その業務が明確に禁止される場合
- 【要確認】: 条件付き、またはケースによる場合

その後、以下を簡潔に説明してください：
1. 判断の根拠（入管法・出入国管理及び難民認定法のどの規定に基づくか）
2. 株式会社アイシンの製造現場における具体的な注意点
3. 必要に応じて、資格外活動許可などの追加手続きの案内

## 情報源（以下の公的機関の情報のみに基づいて回答すること）
- 出入国在留管理庁（法務省）: 在留資格一覧表 https://www.moj.go.jp/isa/applications/status/qaq5.html
- 出入国在留管理庁: 在留資格「特定技能」 https://www.moj.go.jp/isa/applications/status/specifiedskilledworker.html
- 出入国在留管理庁: 在留資格「技術・人文知識・国際業務」 https://www.moj.go.jp/isa/applications/status/gijinkoku.html
- 厚生労働省: 外国人の雇用 https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/koyou/jigyounushi/page11.html
- 厚生労働省: 外国人雇用対策 https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/koyou/gaikokujin/index.html
- 厚生労働省: 就労確認について https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/koyou/jigyounushi/seido/anteikyoku/gairou/980908gai01.htm
※上記以外の情報源（個人ブログ、民間サイト等）は参照しないこと。不確実な場合は「公的機関に確認が必要」と明記する。

## 株式会社アイシンで想定される主な業務
- 製造ライン作業（組立・加工・プレス・溶接・塗装）
- 検品・品質検査・品質管理
- フォークリフト運転・構内物流
- 機械オペレーション・設備保全
- 生産管理・工程管理（事務系）
- 通訳・翻訳（外国人従業員のサポート）
- 技術開発・設計・CAD（エンジニア系）
- 総務・人事・経理（管理部門）
- 清掃・食堂業務（付随業務）

## 在留資格ごとの製造業での就労可否（詳細）

### 身分系在留資格（就労制限なし）
- 永住者 / 日本人の配偶者等 / 永住者の配偶者等 / 定住者
- 製造ラインの単純作業を含め、あらゆる業務に従事可能
- 就労時間の制限もなし
- 根拠: 入管法別表第二（活動制限なし）

### 技術・人文知識・国際業務（技人国）
- 許可される業務: 生産技術エンジニア、品質管理（専門的判断を要するもの）、設計・CAD、IT・システム管理、通訳・翻訳、経理・人事・総務等の事務職
- 禁止される業務: 製造ラインでの単純作業（組立・検品・梱包等）、フォークリフト作業、清掃、食堂業務
- 重要: 「研修」名目であっても、長期間の現場作業は入管法違反の恐れあり。入社後の短期間（概ね1〜2ヶ月程度）の現場研修は許容されるが、研修計画が必要
- 根拠: 入管法別表第一の二「技術・人文知識・国際業務」、出入国在留管理庁ガイドライン

### 特定技能1号
- 許可される分野（製造業関連）: 素形材・産業機械・電気電子情報関連製造業
  - 具体的業務: 鋳造、鍛造、ダイカスト、機械加工、金属プレス加工、工場板金、めっき、アルミニウム陽極酸化処理、仕上げ、機械検査、機械保全、電子機器組立て、電気機器組立て、プリント配線板製造、プラスチック成形、塗装、溶接、工業包装
- 付随的業務（主たる業務に付随して行うもの）: 原材料・部品の調達・搬送、各職種の前後工程作業、クリーンルーム内作業、製品の納品・配送
- 注意: 指定された分野・業務以外は不可。通算5年の上限あり
- 根拠: 特定技能運用要領、分野別運用方針（経済産業省）

### 特定技能2号
- 特定技能1号と同じ分野で、より高い技能水準が求められる
- 在留期間の上限なし、家族帯同可
- 根拠: 入管法別表第一の二「特定技能2号」

### 技能実習（育成就労への移行予定）
- 実習計画に記載された業務のみに限定
- 製造業関連の職種: 機械加工、金属プレス加工、鋳造、鍛造、溶接、工場板金、めっき、仕上げ、機械検査、機械保全、電子機器組立て、電気機器組立て、プリント配線板製造、プラスチック成形、塗装等
- 禁止: 実習計画外の業務への従事、他部署への異動、アルバイト
- 転職は原則不可（やむを得ない事情を除く）
- 根拠: 技能実習法（外国人の技能実習の適正な実施及び技能実習生の保護に関する法律）

### 留学
- 原則就労不可
- 資格外活動許可があれば週28時間まで（長期休暇中は週40時間）
- 製造ラインのアルバイトは可能（時間制限内であれば）
- 風俗営業関連は不可
- 重要: 勤務シフト管理を厳格にし、週28時間を超えないよう管理すること
- 根拠: 入管法第19条（資格外活動の許可）

### 家族滞在
- 原則就労不可
- 資格外活動許可があれば週28時間まで
- 留学と同様に時間管理が必要
- 根拠: 入管法第19条

### 経営・管理
- 会社の経営・管理活動のみ
- 工場での現場作業は不可
- 根拠: 入管法別表第一の二「経営・管理」

### 高度専門職
- 高度専門職1号イ（研究）、ロ（技術）、ハ（経営）に応じた活動
- 製造業では、技術開発・研究職（イ）、エンジニア・管理職（ロ）が該当
- 複合的な活動が認められる場合あり（他の在留資格にない特典）
- 根拠: 入管法別表第一の二「高度専門職」

### 特定活動
- 指定書の内容による（個人ごとに異なる）
- ワーキングホリデー等の場合は製造業のアルバイト可能
- 必ず本人の指定書を確認すること
- 根拠: 入管法別表第一の五「特定活動」

### 企業内転勤
- 海外の関連会社からの転勤者
- 「技術・人文知識・国際業務」と同等の活動に限る
- 製造ラインの単純作業は不可
- 根拠: 入管法別表第一の二「企業内転勤」

## 株式会社アイシンでよくある質問パターン
1. 「技人国の社員を一時的に製造ラインに配置してよいか」→ 短期研修（1〜2ヶ月）は計画があれば可能だが、恒常的な配置はNG
2. 「特定技能の社員に検品だけでなく梱包もさせてよいか」→ 付随的業務として認められる場合あり（分野別運用要領を確認）
3. 「留学生アルバイトにフォークリフトを運転させてよいか」→ 資格外活動許可＋週28時間以内であれば作業自体は可能。ただし別途フォークリフト運転技能講習修了が必要
4. 「技能実習生を別の工程に異動させてよいか」→ 実習計画の変更届が必要。無届での異動は法令違反
5. 「永住者の配偶者を派遣社員として受け入れてよいか」→ 身分系在留資格のため就労制限なし。派遣での就労も可能

## 重要な注意事項
- 回答の最後に必ず、参考にした公的機関のURL（上記の情報源リスト）のうち関連するものを1〜2つ記載すること
- 「最終的な判断は出入国在留管理庁（https://www.moj.go.jp/isa/）または管轄の地方出入国在留管理局にご確認ください」と必ず注記すること
- 不確実な場合は推測せず「公的機関への確認が必要です」と伝えること
- 法改正（特に育成就労制度への移行等）により情報が変わる可能性があることを伝えること
- 回答は日本語で行うこと`;

    const VISA_STATUSES = [
      { category: '身分系（制限なし）', items: ['永住者', '日本人の配偶者等', '永住者の配偶者等', '定住者'] },
      { category: '就労系（アイシンで多い在留資格）', items: ['技術・人文知識・国際業務', '特定技能1号', '特定技能2号', '企業内転勤', '経営・管理', '高度専門職'] },
      { category: '実習・その他', items: ['技能実習', '留学', '家族滞在', '特定活動'] }
    ];

    const WORK_EXAMPLES = [
      '製造ラインの組立作業', 'プレス・溶接作業', '検品・品質検査',
      'フォークリフト運転', '機械オペレーション', '設備保全・メンテナンス',
      '生産管理・工程管理', '通訳・翻訳', '技術開発・設計・CAD',
      '総務・人事・経理', '清掃・食堂業務', '構内物流・搬送'
    ];

    // ===== CHAT =====
    function initChat() {
      conversationHistory = [];
      document.getElementById('chatMessages').innerHTML = '';

      addBotMessage('こんにちは！大森サポートツールです。\n\n株式会社アイシンの製造現場での業務を中心に、在留資格ごとの就労可否を判断します。\n出入国在留管理庁・厚生労働省・法務省の公的情報に基づいて回答します。\n\nまず、確認したい在留資格を選んでください。');

      let optionsHtml = '';
      for (const group of VISA_STATUSES) {
        optionsHtml += `<div class="chat-category-label">${group.category}</div><div class="chat-options">`;
        for (const status of group.items) {
          optionsHtml += `<button class="chat-option-btn" onclick="selectVisa('${status}')">${status}</button>`;
        }
        optionsHtml += '</div>';
      }
      appendOptionsToLastBot(optionsHtml);
    }

    function resetChat() { initChat(); }

    function selectVisa(status) { sendUserMessage(status); }
    function selectWork(work) { sendUserMessage(work); }

    function addBotMessage(text) {
      const el = document.getElementById('chatMessages');
      const bubble = document.createElement('div');
      bubble.className = 'chat-bubble bot';
      bubble.textContent = text;
      el.appendChild(bubble);
      scrollChat();
    }

    function addBotMessageHtml(html) {
      const el = document.getElementById('chatMessages');
      const bubble = document.createElement('div');
      bubble.className = 'chat-bubble bot';
      bubble.innerHTML = html;
      el.appendChild(bubble);
      scrollChat();
    }

    function addUserMessage(text) {
      const el = document.getElementById('chatMessages');
      const bubble = document.createElement('div');
      bubble.className = 'chat-bubble user';
      bubble.textContent = text;
      el.appendChild(bubble);
      scrollChat();
    }

    function appendOptionsToLastBot(optionsHtml) {
      const bubbles = document.querySelectorAll('#chatMessages .chat-bubble.bot');
      if (bubbles.length > 0) {
        const div = document.createElement('div');
        div.innerHTML = optionsHtml;
        bubbles[bubbles.length - 1].appendChild(div);
      }
      scrollChat();
    }

    function showThinking() {
      const el = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.className = 'thinking-indicator';
      div.id = 'thinkingIndicator';
      div.innerHTML = '考え中 <span class="thinking-dots"><span></span><span></span><span></span></span>';
      el.appendChild(div);
      scrollChat();
    }

    function hideThinking() {
      const el = document.getElementById('thinkingIndicator');
      if (el) el.remove();
    }

    function scrollChat() {
      const el = document.getElementById('chatMessages');
      el.scrollTop = el.scrollHeight;
    }

    document.getElementById('chatInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.isComposing) sendChatMessage();
    });

    function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text || isSending) return;
      input.value = '';
      sendUserMessage(text);
    }

    async function sendUserMessage(text) {
      if (isSending) return;

      addUserMessage(text);

      document.querySelectorAll('.chat-option-btn').forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'default';
        btn.onclick = null;
      });

      conversationHistory.push({ role: 'user', parts: [{ text }] });

      isSending = true;
      document.getElementById('chatSendBtn').disabled = true;
      showThinking();

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            system_instruction: { parts: [{ text: SYSTEM_PROMPT }] },
            contents: conversationHistory
          })
        });

        hideThinking();

        if (!res.ok) {
          if (res.status === 429) {
            addBotMessage('APIの利用制限に達しました。しばらく待ってから再度お試しください。');
          } else {
            addBotMessage('エラーが発生しました。もう一度お試しください。');
          }
          conversationHistory.pop();
          isSending = false;
          document.getElementById('chatSendBtn').disabled = false;
          return;
        }

        const data = await res.json();
        const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || '回答を生成できませんでした。';

        conversationHistory.push({ role: 'model', parts: [{ text: reply }] });

        addBotMessageHtml(formatBotReply(reply));

        if (conversationHistory.length <= 4) {
          let workHtml = '<div class="chat-category-label">業務の例（クリックで質問）</div><div class="chat-options">';
          for (const work of WORK_EXAMPLES) {
            workHtml += `<button class="chat-option-btn" onclick="selectWork('${work}')">${work}</button>`;
          }
          workHtml += '</div>';
          appendOptionsToLastBot(workHtml);
        }

      } catch (err) {
        hideThinking();
        addBotMessage('通信エラーが発生しました。インターネット接続を確認してください。');
        conversationHistory.pop();
      }

      isSending = false;
      document.getElementById('chatSendBtn').disabled = false;
    }

    function formatBotReply(text) {
      let html = escapeHtml(text);
      html = html.replace(/【OK\s*[-−–]\s*就労可能】/g, '<span style="display:inline-block;background:#27ae60;color:#fff;padding:2px 10px;border-radius:8px;font-weight:bold;font-size:0.85rem;">OK - 就労可能</span>');
      html = html.replace(/【NG\s*[-−–]\s*就労不可】/g, '<span style="display:inline-block;background:#e74c3c;color:#fff;padding:2px 10px;border-radius:8px;font-weight:bold;font-size:0.85rem;">NG - 就労不可</span>');
      html = html.replace(/【要確認】/g, '<span style="display:inline-block;background:#f39c12;color:#fff;padding:2px 10px;border-radius:8px;font-weight:bold;font-size:0.85rem;">要確認</span>');
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      return html;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Start
    initChat();
  </script>
</body>
</html>
