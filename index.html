<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LifeHelper JP</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    /* ===== LAYOUT ===== */
    .app-layout {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 280px;
      flex-shrink: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid rgba(255, 255, 255, 0.12);
    }

    .sidebar-header {
      text-align: center;
      margin-bottom: 28px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.12);
    }

    .site-title {
      color: #fff;
      font-size: 1.4rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .site-subtitle {
      color: rgba(255,255,255,0.6);
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .sidebar-nav { flex: 1; }

    .nav-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 14px;
      border-radius: 12px;
      color: rgba(255, 255, 255, 0.65);
      text-decoration: none;
      transition: all 0.2s;
      margin-bottom: 6px;
      cursor: pointer;
      border: 1px solid transparent;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.08);
      color: #fff;
    }

    .nav-item.active {
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      border-color: rgba(255, 255, 255, 0.15);
    }

    .nav-icon {
      font-size: 1.4rem;
      flex-shrink: 0;
      width: 32px;
      text-align: center;
      line-height: 1;
      margin-top: 2px;
    }

    .nav-label {
      display: block;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .nav-desc {
      display: block;
      font-size: 0.75rem;
      opacity: 0.65;
      margin-top: 4px;
      line-height: 1.5;
    }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.4);
      font-size: 0.7rem;
      text-align: center;
      line-height: 1.5;
    }

    .main-content {
      flex: 1;
      overflow-y: auto;
      height: 100vh;
    }

    .page { display: none; }
    .page.active { display: block; }

    /* ===== WEATHER PAGE ===== */
    .weather-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .page-title {
      text-align: center;
      color: #fff;
      font-size: 1.8rem;
      margin: 20px 0 30px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
    }

    .search-box input {
      flex: 1;
      padding: 12px 18px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      outline: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .search-box button {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      background: #ff6b6b;
      color: #fff;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: background 0.2s;
    }

    .search-box button:hover { background: #ee5a5a; }

    .geo-btn {
      display: block;
      margin: 0 auto 20px;
      padding: 10px 20px;
      border: 2px solid rgba(255,255,255,0.6);
      border-radius: 12px;
      background: transparent;
      color: #fff;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .geo-btn:hover { background: rgba(255,255,255,0.15); }

    .loading {
      text-align: center;
      color: #fff;
      font-size: 1.2rem;
      padding: 40px;
    }

    .error {
      text-align: center;
      background: rgba(255,255,255,0.9);
      padding: 20px;
      border-radius: 12px;
      color: #e74c3c;
      font-weight: bold;
    }

    .current-weather {
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      text-align: center;
    }

    .city-name {
      font-size: 1.5rem;
      font-weight: bold;
      color: #555;
      margin-bottom: 10px;
    }

    .current-temp {
      font-size: 4rem;
      font-weight: bold;
      color: #333;
    }

    .current-icon { font-size: 4rem; }

    .current-details {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-top: 15px;
      color: #666;
    }

    .current-details span { font-size: 0.95rem; }

    .forecast-title {
      color: #fff;
      font-size: 1.3rem;
      margin: 25px 0 15px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .forecast-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 12px;
    }

    .forecast-card {
      background: rgba(255,255,255,0.92);
      border-radius: 12px;
      padding: 15px 10px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .forecast-card .day {
      font-size: 0.85rem;
      color: #888;
      margin-bottom: 8px;
    }

    .forecast-card .icon { font-size: 2rem; }

    .forecast-card .temp {
      margin-top: 8px;
      font-size: 0.9rem;
    }

    .forecast-card .temp-high { color: #e74c3c; font-weight: bold; }
    .forecast-card .temp-low { color: #3498db; }

    .hourly-list {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 10px;
    }

    .hourly-card {
      flex-shrink: 0;
      background: rgba(255,255,255,0.92);
      border-radius: 12px;
      padding: 12px 14px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      min-width: 80px;
    }

    .hourly-card .time {
      font-size: 0.8rem;
      color: #888;
      margin-bottom: 6px;
    }

    .hourly-card .icon { font-size: 1.5rem; }

    .hourly-card .temp {
      margin-top: 6px;
      font-weight: bold;
      font-size: 0.95rem;
    }

    /* ===== VISA CHATBOT PAGE ===== */
    .chat-page {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: rgba(0, 0, 0, 0.15);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .chat-header h2 {
      color: #fff;
      font-size: 1.2rem;
      text-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .chat-header-btns {
      display: flex;
      gap: 8px;
    }

    .chat-reset-btn, .chat-apikey-btn {
      padding: 6px 14px;
      border: 1px solid rgba(255,255,255,0.4);
      border-radius: 8px;
      background: transparent;
      color: rgba(255,255,255,0.8);
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .chat-reset-btn:hover, .chat-apikey-btn:hover {
      background: rgba(255,255,255,0.12);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .chat-bubble {
      max-width: 80%;
      padding: 14px 18px;
      border-radius: 16px;
      line-height: 1.7;
      font-size: 0.92rem;
      white-space: pre-wrap;
    }

    .chat-bubble.bot {
      align-self: flex-start;
      background: rgba(255, 255, 255, 0.95);
      color: #333;
      border-bottom-left-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .chat-bubble.user {
      align-self: flex-end;
      background: #667eea;
      color: #fff;
      border-bottom-right-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .chat-bubble.system {
      align-self: center;
      background: rgba(255,255,255,0.15);
      color: rgba(255,255,255,0.85);
      font-size: 0.82rem;
      text-align: center;
      padding: 8px 16px;
      border-radius: 8px;
    }

    .chat-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .chat-option-btn {
      padding: 8px 16px;
      border: 2px solid #667eea;
      border-radius: 20px;
      background: rgba(255,255,255,0.95);
      color: #667eea;
      cursor: pointer;
      font-size: 0.82rem;
      transition: all 0.2s;
    }

    .chat-option-btn:hover {
      background: #667eea;
      color: #fff;
    }

    .chat-category-label {
      font-size: 0.75rem;
      color: #888;
      margin-top: 8px;
      margin-bottom: 4px;
      font-weight: bold;
    }

    .chat-input-area {
      display: flex;
      gap: 10px;
      padding: 16px 24px;
      background: rgba(0, 0, 0, 0.1);
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .chat-input-area input {
      flex: 1;
      padding: 12px 18px;
      border: none;
      border-radius: 12px;
      font-size: 0.95rem;
      outline: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .chat-input-area input:disabled {
      background: #e9e9e9;
    }

    .chat-send-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      background: #667eea;
      color: #fff;
      font-size: 0.95rem;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .chat-send-btn:hover { background: #5a6fd6; }
    .chat-send-btn:disabled { background: #aaa; cursor: not-allowed; }

    .chat-disclaimer {
      padding: 8px 24px;
      background: rgba(0,0,0,0.2);
      color: rgba(255,255,255,0.5);
      font-size: 0.7rem;
      text-align: center;
    }

    .thinking-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      align-self: flex-start;
      padding: 12px 18px;
      background: rgba(255,255,255,0.9);
      border-radius: 16px;
      border-bottom-left-radius: 4px;
      color: #888;
      font-size: 0.85rem;
    }

    .thinking-dots span {
      display: inline-block;
      width: 6px;
      height: 6px;
      background: #888;
      border-radius: 50%;
      animation: blink 1.4s infinite;
      margin: 0 2px;
    }

    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0.3; }
      40% { opacity: 1; }
    }

    /* ===== API KEY MODAL ===== */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.hidden { display: none; }

    .modal {
      background: #fff;
      border-radius: 16px;
      padding: 30px;
      max-width: 460px;
      width: 90%;
      box-shadow: 0 12px 40px rgba(0,0,0,0.3);
    }

    .modal h3 {
      margin-bottom: 12px;
      color: #333;
    }

    .modal p {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 16px;
      line-height: 1.6;
    }

    .modal input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 0.95rem;
      outline: none;
      margin-bottom: 16px;
      transition: border-color 0.2s;
    }

    .modal input:focus { border-color: #667eea; }

    .modal-btns {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 10px 22px;
      border: none;
      border-radius: 10px;
      font-size: 0.9rem;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }

    .modal-btn.primary {
      background: #667eea;
      color: #fff;
    }

    .modal-btn.primary:hover { background: #5a6fd6; }

    .modal-btn.secondary {
      background: #eee;
      color: #666;
    }

    .modal-btn.secondary:hover { background: #ddd; }

    /* ===== MOBILE ===== */
    @media (max-width: 768px) {
      .sidebar { width: 220px; padding: 16px 10px; }
      .chat-bubble { max-width: 90%; }
    }
  </style>
</head>
<body>
  <div class="app-layout">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1 class="site-title">LifeHelper JP</h1>
        <p class="site-subtitle">Japan Life Tools</p>
      </div>

      <nav class="sidebar-nav">
        <a href="#weather" class="nav-item active" data-page="weather">
          <span class="nav-icon">&#9925;</span>
          <div>
            <span class="nav-label">天気予報</span>
            <span class="nav-desc">都市名や現在地から天気・週間予報・24時間予報を表示します</span>
          </div>
        </a>
        <a href="#visa" class="nav-item" data-page="visa">
          <span class="nav-icon">&#128196;</span>
          <div>
            <span class="nav-label">在留資格チャットボット</span>
            <span class="nav-desc">株式会社アイシンの製造業務に特化。在留資格ごとの就労可否をAIが判断します</span>
          </div>
        </a>
      </nav>

      <div class="sidebar-footer">
        ローカル動作アプリ<br>
        天気: Open-Meteo API<br>
        チャット: Gemini API
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">

      <!-- ===== WEATHER PAGE ===== -->
      <div id="page-weather" class="page active">
        <div class="weather-container">
          <h2 class="page-title">天気予報</h2>
          <div class="search-box">
            <input type="text" id="cityInput" placeholder="都市名を入力（例: Tokyo, Osaka）" />
            <button onclick="searchCity()">検索</button>
          </div>
          <button class="geo-btn" onclick="useGeolocation()">現在地の天気を取得</button>
          <div id="weatherResult"></div>
        </div>
      </div>

      <!-- ===== VISA CHATBOT PAGE ===== -->
      <div id="page-visa" class="page">
        <div class="chat-page">
          <div class="chat-header">
            <h2>株式会社アイシン 在留資格・就労相談ボット</h2>
            <div class="chat-header-btns">
              <button class="chat-apikey-btn" onclick="showApiKeyModal()">APIキー設定</button>
              <button class="chat-reset-btn" onclick="resetChat()">リセット</button>
            </div>
          </div>
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="質問を入力してください..." />
            <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">送信</button>
          </div>
          <div class="chat-disclaimer">
            ※ 出入国在留管理庁・厚生労働省・法務省の公的情報に基づくAI回答です。最終判断は管轄の地方出入国在留管理局にご確認ください。
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- API KEY MODAL -->
  <div class="modal-overlay hidden" id="apiKeyModal">
    <div class="modal">
      <h3>Gemini APIキーを設定</h3>
      <p>
        Google AI Studio からAPIキーを無料で取得できます。<br>
        取得先: <strong>https://aistudio.google.com/apikey</strong>
      </p>
      <input type="text" id="apiKeyInput" placeholder="AIza..." />
      <div class="modal-btns">
        <button class="modal-btn secondary" onclick="closeApiKeyModal()">キャンセル</button>
        <button class="modal-btn primary" onclick="saveApiKey()">保存</button>
      </div>
    </div>
  </div>

  <script>
    // ===== ROUTER =====
    function initRouter() {
      window.addEventListener('hashchange', handleRoute);
      handleRoute();
    }

    function handleRoute() {
      const hash = window.location.hash.replace('#', '') || 'weather';
      const validPages = ['weather', 'visa'];
      const page = validPages.includes(hash) ? hash : 'weather';

      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + page).classList.add('active');

      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.page === page);
      });

      if (page === 'visa' && !chatInitialized) {
        initChat();
      }
    }

    document.addEventListener('DOMContentLoaded', initRouter);

    // ===== WEATHER =====
    const WMO_ICONS = {
      0: '\u2600\uFE0F', 1: '\uD83C\uDF24\uFE0F', 2: '\u26C5', 3: '\u2601\uFE0F',
      45: '\uD83C\uDF2B\uFE0F', 48: '\uD83C\uDF2B\uFE0F',
      51: '\uD83C\uDF26\uFE0F', 53: '\uD83C\uDF26\uFE0F', 55: '\uD83C\uDF27\uFE0F',
      56: '\uD83C\uDF27\uFE0F', 57: '\uD83C\uDF27\uFE0F',
      61: '\uD83C\uDF27\uFE0F', 63: '\uD83C\uDF27\uFE0F', 65: '\uD83C\uDF27\uFE0F',
      66: '\uD83C\uDF27\uFE0F', 67: '\uD83C\uDF27\uFE0F',
      71: '\uD83C\uDF28\uFE0F', 73: '\uD83C\uDF28\uFE0F', 75: '\u2744\uFE0F',
      77: '\u2744\uFE0F',
      80: '\uD83C\uDF26\uFE0F', 81: '\uD83C\uDF27\uFE0F', 82: '\uD83C\uDF27\uFE0F',
      85: '\uD83C\uDF28\uFE0F', 86: '\uD83C\uDF28\uFE0F',
      95: '\u26C8\uFE0F', 96: '\u26C8\uFE0F', 99: '\u26C8\uFE0F',
    };

    const WMO_DESC = {
      0: '快晴', 1: 'ほぼ晴れ', 2: 'くもり時々晴れ', 3: 'くもり',
      45: '霧', 48: '霧',
      51: '小雨', 53: '雨', 55: '強い雨',
      56: '着氷性の霧雨', 57: '着氷性の霧雨',
      61: '小雨', 63: '雨', 65: '大雨',
      66: '着氷性の雨', 67: '着氷性の雨',
      71: '小雪', 73: '雪', 75: '大雪',
      77: '霰', 80: 'にわか雨', 81: 'にわか雨', 82: '激しいにわか雨',
      85: 'にわか雪', 86: '激しいにわか雪',
      95: '雷雨', 96: '雹を伴う雷雨', 99: '雹を伴う雷雨',
    };

    const DAYS = ['日', '月', '火', '水', '木', '金', '土'];

    document.getElementById('cityInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') searchCity();
    });

    async function searchCity() {
      const city = document.getElementById('cityInput').value.trim();
      if (!city) return;
      showWeatherLoading();
      try {
        const geoRes = await fetch(
          `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=ja`
        );
        const geoData = await geoRes.json();
        if (!geoData.results || geoData.results.length === 0) {
          showWeatherError('都市が見つかりませんでした');
          return;
        }
        const loc = geoData.results[0];
        await fetchWeather(loc.latitude, loc.longitude, loc.name);
      } catch (err) {
        showWeatherError('検索中にエラーが発生しました');
      }
    }

    function useGeolocation() {
      if (!navigator.geolocation) {
        showWeatherError('このブラウザは位置情報に対応していません');
        return;
      }
      showWeatherLoading();
      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          await fetchWeather(pos.coords.latitude, pos.coords.longitude, '現在地');
        },
        () => showWeatherError('位置情報を取得できませんでした')
      );
    }

    async function fetchWeather(lat, lon, name) {
      try {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`
          + `&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code`
          + `&hourly=temperature_2m,weather_code`
          + `&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max`
          + `&timezone=Asia%2FTokyo&forecast_days=7`;
        const res = await fetch(url);
        const data = await res.json();
        renderWeather(data, name);
      } catch (err) {
        showWeatherError('天気データの取得に失敗しました');
      }
    }

    function renderWeather(data, cityName) {
      const c = data.current;
      const code = c.weather_code;
      let html = `
        <div class="current-weather">
          <div class="city-name">${cityName}</div>
          <div class="current-icon">${WMO_ICONS[code] || '\uD83C\uDF21\uFE0F'}</div>
          <div class="current-temp">${Math.round(c.temperature_2m)}\u00B0C</div>
          <div style="color:#666; margin-top:4px">${WMO_DESC[code] || ''}</div>
          <div class="current-details">
            <span>\uD83D\uDCA7 湿度 ${c.relative_humidity_2m}%</span>
            <span>\uD83D\uDCA8 風速 ${c.wind_speed_10m} km/h</span>
          </div>
        </div>
      `;

      html += `<div class="forecast-title">24時間予報</div><div class="hourly-list">`;
      const nowHour = new Date().getHours();
      const hourlyStart = data.hourly.time.findIndex(t => new Date(t).getHours() >= nowHour && new Date(t) >= new Date());
      const hourlySlice = Math.max(hourlyStart, 0);
      for (let i = hourlySlice; i < hourlySlice + 24 && i < data.hourly.time.length; i++) {
        const d = new Date(data.hourly.time[i]);
        const hCode = data.hourly.weather_code[i];
        html += `
          <div class="hourly-card">
            <div class="time">${d.getHours()}時</div>
            <div class="icon">${WMO_ICONS[hCode] || '\uD83C\uDF21\uFE0F'}</div>
            <div class="temp">${Math.round(data.hourly.temperature_2m[i])}\u00B0</div>
          </div>
        `;
      }
      html += `</div>`;

      html += `<div class="forecast-title">週間予報</div><div class="forecast-grid">`;
      for (let i = 0; i < data.daily.time.length; i++) {
        const d = new Date(data.daily.time[i]);
        const dayLabel = i === 0 ? '今日' : `${d.getMonth() + 1}/${d.getDate()}(${DAYS[d.getDay()]})`;
        const dCode = data.daily.weather_code[i];
        const rain = data.daily.precipitation_probability_max[i];
        html += `
          <div class="forecast-card">
            <div class="day">${dayLabel}</div>
            <div class="icon">${WMO_ICONS[dCode] || '\uD83C\uDF21\uFE0F'}</div>
            <div class="temp">
              <span class="temp-high">${Math.round(data.daily.temperature_2m_max[i])}\u00B0</span>
              /
              <span class="temp-low">${Math.round(data.daily.temperature_2m_min[i])}\u00B0</span>
            </div>
            <div style="font-size:0.8rem;color:#888;margin-top:4px">\u2614 ${rain}%</div>
          </div>
        `;
      }
      html += `</div>`;

      document.getElementById('weatherResult').innerHTML = html;
    }

    function showWeatherLoading() {
      document.getElementById('weatherResult').innerHTML = '<div class="loading">取得中...</div>';
    }

    function showWeatherError(msg) {
      document.getElementById('weatherResult').innerHTML = `<div class="error">${msg}</div>`;
    }

    // ===== VISA CHATBOT =====
    let chatInitialized = false;
    let conversationHistory = [];
    let isSending = false;

    const SYSTEM_PROMPT = `あなたは「株式会社アイシン」の人事部門を支援する、在留資格と就労制限の専門アシスタントです。
株式会社アイシンは製造業（工場での生産・加工・組立・検品等）を主たる事業としており、外国人従業員を幅広い在留資格で雇用しています。

## あなたの役割
- 株式会社アイシンの人事担当者からの質問に対して、製造業の現場に即した正確で実用的な回答を提供する
- ユーザーから「在留資格の種類」と「従事させたい業務内容」を聞き取り、その業務が当該在留資格で許可されるか判断する
- まだ在留資格が伝えられていない場合は、まず在留資格を確認する
- 在留資格がわかったら、具体的にどのような製造業務について知りたいか聞く

## 回答フォーマット
回答の最初の行は必ず以下のいずれかのタグで始めてください：
- 【OK - 就労可能】: その業務が明確に許可される場合
- 【NG - 就労不可】: その業務が明確に禁止される場合
- 【要確認】: 条件付き、またはケースによる場合

その後、以下を簡潔に説明してください：
1. 判断の根拠（入管法・出入国管理及び難民認定法のどの規定に基づくか）
2. 株式会社アイシンの製造現場における具体的な注意点
3. 必要に応じて、資格外活動許可などの追加手続きの案内

## 情報源（以下の公的機関の情報のみに基づいて回答すること）
- 出入国在留管理庁（法務省）: 在留資格一覧表 https://www.moj.go.jp/isa/applications/status/qaq5.html
- 出入国在留管理庁: 在留資格「特定技能」 https://www.moj.go.jp/isa/applications/status/specifiedskilledworker.html
- 出入国在留管理庁: 在留資格「技術・人文知識・国際業務」 https://www.moj.go.jp/isa/applications/status/gijinkoku.html
- 厚生労働省: 外国人の雇用 https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/koyou/jigyounushi/page11.html
- 厚生労働省: 外国人雇用対策 https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/koyou/gaikokujin/index.html
- 厚生労働省: 就労確認について https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/koyou_roudou/koyou/jigyounushi/seido/anteikyoku/gairou/980908gai01.htm
※上記以外の情報源（個人ブログ、民間サイト等）は参照しないこと。不確実な場合は「公的機関に確認が必要」と明記する。

## 株式会社アイシンで想定される主な業務
- 製造ライン作業（組立・加工・プレス・溶接・塗装）
- 検品・品質検査・品質管理
- フォークリフト運転・構内物流
- 機械オペレーション・設備保全
- 生産管理・工程管理（事務系）
- 通訳・翻訳（外国人従業員のサポート）
- 技術開発・設計・CAD（エンジニア系）
- 総務・人事・経理（管理部門）
- 清掃・食堂業務（付随業務）

## 在留資格ごとの製造業での就労可否（詳細）

### 身分系在留資格（就労制限なし）
- 永住者 / 日本人の配偶者等 / 永住者の配偶者等 / 定住者
- 製造ラインの単純作業を含め、あらゆる業務に従事可能
- 就労時間の制限もなし
- 根拠: 入管法別表第二（活動制限なし）

### 技術・人文知識・国際業務（技人国）
- 許可される業務: 生産技術エンジニア、品質管理（専門的判断を要するもの）、設計・CAD、IT・システム管理、通訳・翻訳、経理・人事・総務等の事務職
- 禁止される業務: 製造ラインでの単純作業（組立・検品・梱包等）、フォークリフト作業、清掃、食堂業務
- 重要: 「研修」名目であっても、長期間の現場作業は入管法違反の恐れあり。入社後の短期間（概ね1〜2ヶ月程度）の現場研修は許容されるが、研修計画が必要
- 根拠: 入管法別表第一の二「技術・人文知識・国際業務」、出入国在留管理庁ガイドライン

### 特定技能1号
- 許可される分野（製造業関連）: 素形材・産業機械・電気電子情報関連製造業
  - 具体的業務: 鋳造、鍛造、ダイカスト、機械加工、金属プレス加工、工場板金、めっき、アルミニウム陽極酸化処理、仕上げ、機械検査、機械保全、電子機器組立て、電気機器組立て、プリント配線板製造、プラスチック成形、塗装、溶接、工業包装
- 付随的業務（主たる業務に付随して行うもの）: 原材料・部品の調達・搬送、各職種の前後工程作業、クリーンルーム内作業、製品の納品・配送
- 注意: 指定された分野・業務以外は不可。通算5年の上限あり
- 根拠: 特定技能運用要領、分野別運用方針（経済産業省）

### 特定技能2号
- 特定技能1号と同じ分野で、より高い技能水準が求められる
- 在留期間の上限なし、家族帯同可
- 根拠: 入管法別表第一の二「特定技能2号」

### 技能実習（育成就労への移行予定）
- 実習計画に記載された業務のみに限定
- 製造業関連の職種: 機械加工、金属プレス加工、鋳造、鍛造、溶接、工場板金、めっき、仕上げ、機械検査、機械保全、電子機器組立て、電気機器組立て、プリント配線板製造、プラスチック成形、塗装等
- 禁止: 実習計画外の業務への従事、他部署への異動、アルバイト
- 転職は原則不可（やむを得ない事情を除く）
- 根拠: 技能実習法（外国人の技能実習の適正な実施及び技能実習生の保護に関する法律）

### 留学
- 原則就労不可
- 資格外活動許可があれば週28時間まで（長期休暇中は週40時間）
- 製造ラインのアルバイトは可能（時間制限内であれば）
- 風俗営業関連は不可
- 重要: 勤務シフト管理を厳格にし、週28時間を超えないよう管理すること
- 根拠: 入管法第19条（資格外活動の許可）

### 家族滞在
- 原則就労不可
- 資格外活動許可があれば週28時間まで
- 留学と同様に時間管理が必要
- 根拠: 入管法第19条

### 経営・管理
- 会社の経営・管理活動のみ
- 工場での現場作業は不可
- 根拠: 入管法別表第一の二「経営・管理」

### 高度専門職
- 高度専門職1号イ（研究）、ロ（技術）、ハ（経営）に応じた活動
- 製造業では、技術開発・研究職（イ）、エンジニア・管理職（ロ）が該当
- 複合的な活動が認められる場合あり（他の在留資格にない特典）
- 根拠: 入管法別表第一の二「高度専門職」

### 特定活動
- 指定書の内容による（個人ごとに異なる）
- ワーキングホリデー等の場合は製造業のアルバイト可能
- 必ず本人の指定書を確認すること
- 根拠: 入管法別表第一の五「特定活動」

### 企業内転勤
- 海外の関連会社からの転勤者
- 「技術・人文知識・国際業務」と同等の活動に限る
- 製造ラインの単純作業は不可
- 根拠: 入管法別表第一の二「企業内転勤」

## 株式会社アイシンでよくある質問パターン
1. 「技人国の社員を一時的に製造ラインに配置してよいか」→ 短期研修（1〜2ヶ月）は計画があれば可能だが、恒常的な配置はNG
2. 「特定技能の社員に検品だけでなく梱包もさせてよいか」→ 付随的業務として認められる場合あり（分野別運用要領を確認）
3. 「留学生アルバイトにフォークリフトを運転させてよいか」→ 資格外活動許可＋週28時間以内であれば作業自体は可能。ただし別途フォークリフト運転技能講習修了が必要
4. 「技能実習生を別の工程に異動させてよいか」→ 実習計画の変更届が必要。無届での異動は法令違反
5. 「永住者の配偶者を派遣社員として受け入れてよいか」→ 身分系在留資格のため就労制限なし。派遣での就労も可能

## 重要な注意事項
- 回答の最後に必ず、参考にした公的機関のURL（上記の情報源リスト）のうち関連するものを1〜2つ記載すること
- 「最終的な判断は出入国在留管理庁（https://www.moj.go.jp/isa/）または管轄の地方出入国在留管理局にご確認ください」と必ず注記すること
- 不確実な場合は推測せず「公的機関への確認が必要です」と伝えること
- 法改正（特に育成就労制度への移行等）により情報が変わる可能性があることを伝えること
- 回答は日本語で行うこと`;

    const VISA_STATUSES = [
      { category: '身分系（制限なし）', items: ['永住者', '日本人の配偶者等', '永住者の配偶者等', '定住者'] },
      { category: '就労系（アイシンで多い在留資格）', items: ['技術・人文知識・国際業務', '特定技能1号', '特定技能2号', '企業内転勤', '経営・管理', '高度専門職'] },
      { category: '実習・その他', items: ['技能実習', '留学', '家族滞在', '特定活動'] }
    ];

    const WORK_EXAMPLES = [
      '製造ラインの組立作業', 'プレス・溶接作業', '検品・品質検査',
      'フォークリフト運転', '機械オペレーション', '設備保全・メンテナンス',
      '生産管理・工程管理', '通訳・翻訳', '技術開発・設計・CAD',
      '総務・人事・経理', '清掃・食堂業務', '構内物流・搬送'
    ];

    function getApiKey() {
      return localStorage.getItem('gemini_api_key') || '';
    }

    function showApiKeyModal() {
      document.getElementById('apiKeyInput').value = getApiKey();
      document.getElementById('apiKeyModal').classList.remove('hidden');
    }

    function closeApiKeyModal() {
      document.getElementById('apiKeyModal').classList.add('hidden');
    }

    function saveApiKey() {
      const key = document.getElementById('apiKeyInput').value.trim();
      if (key) {
        localStorage.setItem('gemini_api_key', key);
        closeApiKeyModal();
        if (!chatInitialized) {
          initChat();
        } else {
          addBotMessage('APIキーを保存しました。');
        }
      }
    }

    function initChat() {
      chatInitialized = true;
      conversationHistory = [];
      const messagesEl = document.getElementById('chatMessages');
      messagesEl.innerHTML = '';

      if (!getApiKey()) {
        showApiKeyModal();
        addBotMessage('Gemini APIキーを設定してください。\n\nGoogle AI Studio (https://aistudio.google.com/apikey) から無料で取得できます。');
        return;
      }

      let welcomeHtml = 'こんにちは！株式会社アイシンの在留資格・就労相談ボットです。\n\n製造現場での業務を中心に、在留資格ごとの就労可否を判断します。\n出入国在留管理庁・厚生労働省・法務省の公的情報に基づいて回答します。\n\nまず、確認したい在留資格を選んでください。';
      addBotMessage(welcomeHtml);

      // Add visa status buttons
      let optionsHtml = '';
      for (const group of VISA_STATUSES) {
        optionsHtml += `<div class="chat-category-label">${group.category}</div><div class="chat-options">`;
        for (const status of group.items) {
          optionsHtml += `<button class="chat-option-btn" onclick="selectVisa('${status}')">${status}</button>`;
        }
        optionsHtml += '</div>';
      }
      appendOptionsToLastBot(optionsHtml);
    }

    function resetChat() {
      chatInitialized = false;
      initChat();
    }

    function selectVisa(status) {
      sendUserMessage(status);
    }

    function selectWork(work) {
      sendUserMessage(work);
    }

    function addBotMessage(text) {
      const messagesEl = document.getElementById('chatMessages');
      const bubble = document.createElement('div');
      bubble.className = 'chat-bubble bot';
      bubble.textContent = text;
      messagesEl.appendChild(bubble);
      scrollChat();
    }

    function addBotMessageHtml(html) {
      const messagesEl = document.getElementById('chatMessages');
      const bubble = document.createElement('div');
      bubble.className = 'chat-bubble bot';
      bubble.innerHTML = html;
      messagesEl.appendChild(bubble);
      scrollChat();
    }

    function addUserMessage(text) {
      const messagesEl = document.getElementById('chatMessages');
      const bubble = document.createElement('div');
      bubble.className = 'chat-bubble user';
      bubble.textContent = text;
      messagesEl.appendChild(bubble);
      scrollChat();
    }

    function appendOptionsToLastBot(optionsHtml) {
      const messagesEl = document.getElementById('chatMessages');
      const botBubbles = messagesEl.querySelectorAll('.chat-bubble.bot');
      if (botBubbles.length > 0) {
        const last = botBubbles[botBubbles.length - 1];
        const div = document.createElement('div');
        div.innerHTML = optionsHtml;
        last.appendChild(div);
      }
      scrollChat();
    }

    function showThinking() {
      const messagesEl = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.className = 'thinking-indicator';
      div.id = 'thinkingIndicator';
      div.innerHTML = '考え中 <span class="thinking-dots"><span></span><span></span><span></span></span>';
      messagesEl.appendChild(div);
      scrollChat();
    }

    function hideThinking() {
      const el = document.getElementById('thinkingIndicator');
      if (el) el.remove();
    }

    function scrollChat() {
      const messagesEl = document.getElementById('chatMessages');
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    document.getElementById('chatInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.isComposing) sendChatMessage();
    });

    function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text || isSending) return;
      input.value = '';
      sendUserMessage(text);
    }

    async function sendUserMessage(text) {
      if (isSending) return;

      if (!getApiKey()) {
        showApiKeyModal();
        return;
      }

      addUserMessage(text);

      // Disable option buttons after selection
      document.querySelectorAll('.chat-option-btn').forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'default';
        btn.onclick = null;
      });

      conversationHistory.push({
        role: 'user',
        parts: [{ text: text }]
      });

      isSending = true;
      document.getElementById('chatSendBtn').disabled = true;
      showThinking();

      try {
        const apiKey = getApiKey();
        const res = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              system_instruction: { parts: [{ text: SYSTEM_PROMPT }] },
              contents: conversationHistory
            })
          }
        );

        hideThinking();

        if (!res.ok) {
          const errData = await res.json().catch(() => ({}));
          if (res.status === 400 || res.status === 403) {
            addBotMessage('APIキーが無効です。正しいキーを設定してください。');
            showApiKeyModal();
          } else if (res.status === 429) {
            addBotMessage('APIの利用制限に達しました。しばらく待ってから再度お試しください。');
          } else {
            addBotMessage('エラーが発生しました。もう一度お試しください。');
          }
          conversationHistory.pop();
          isSending = false;
          document.getElementById('chatSendBtn').disabled = false;
          return;
        }

        const data = await res.json();
        const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || '回答を生成できませんでした。';

        conversationHistory.push({
          role: 'model',
          parts: [{ text: reply }]
        });

        // Format the response with colored badges
        const formattedReply = formatBotReply(reply);
        addBotMessageHtml(formattedReply);

        // Show work example buttons after first response
        if (conversationHistory.length <= 4) {
          let workHtml = '<div class="chat-category-label">業務の例（クリックで質問）</div><div class="chat-options">';
          for (const work of WORK_EXAMPLES) {
            workHtml += `<button class="chat-option-btn" onclick="selectWork('${work}')">${work}</button>`;
          }
          workHtml += '</div>';
          appendOptionsToLastBot(workHtml);
        }

      } catch (err) {
        hideThinking();
        addBotMessage('通信エラーが発生しました。インターネット接続を確認してください。');
        conversationHistory.pop();
      }

      isSending = false;
      document.getElementById('chatSendBtn').disabled = false;
    }

    function formatBotReply(text) {
      let html = escapeHtml(text);

      // Color the result badges
      html = html.replace(/【OK\s*[-−–]\s*就労可能】/g, '<span style="display:inline-block;background:#27ae60;color:#fff;padding:2px 10px;border-radius:8px;font-weight:bold;font-size:0.85rem;">OK - 就労可能</span>');
      html = html.replace(/【NG\s*[-−–]\s*就労不可】/g, '<span style="display:inline-block;background:#e74c3c;color:#fff;padding:2px 10px;border-radius:8px;font-weight:bold;font-size:0.85rem;">NG - 就労不可</span>');
      html = html.replace(/【要確認】/g, '<span style="display:inline-block;background:#f39c12;color:#fff;padding:2px 10px;border-radius:8px;font-weight:bold;font-size:0.85rem;">要確認</span>');

      // Bold text between ** **
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

      return html;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
